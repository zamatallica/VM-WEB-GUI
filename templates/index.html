<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Secure Proxmox Access</title>
    <link
    href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined|Material+Icons+Round|Material+Icons+Sharp|Material+Icons+Two+Tone" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com" >
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin >
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@200;300;400;500;600;700;800&family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', filename='js/init.js') }}"></script>
    <script type="module">
        import RFB from 'https://cdn.jsdelivr.net/npm/@novnc/novnc@1.3.0/core/rfb.js';
        window.RFB = RFB;  // Expose RFB globally

        async function checkSession() {
            try {
                const response = await fetch('/api/check-session', {
                    method: 'GET',
                    credentials: 'include'  // Include cookies in the request
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('username-display').textContent = data.user.toLowerCase();
                    document.getElementById('loginContainer').classList.add('hidden');
                    document.getElementById('mainInterface').classList.remove('hidden');
                    document.getElementById('mainInterface_right').classList.remove('hidden');
                    getUserProfileInfo();
                    populateVMsDropDown();
                }
            } catch (error) {
                console.error('Session check error:', error);
            }
        }

        // Call this function when the page loads
        window.onload = checkSession;

        function loadNoVNC(callback) {
            if (typeof window.RFB !== "undefined") {
                console.log("RFB already loaded.");
                callback();
                return;
            }
    
            console.log("Loading noVNC...");
            const script = document.createElement("script");
            script.src = "https://cdn.jsdelivr.net/npm/@novnc/novnc@1.3.0/core/rfb.js";
            script.type = "module";
    
            script.onload = function() {
                console.log("noVNC Loaded Successfully!");
                window.RFB = window.RFB || window.default;
                callback();
            };
    
            script.onerror = function() {
                console.error(" Failed to load noVNC!");
            };
    
            document.head.appendChild(script);
        }
    
        // Load noVNC before connecting
        loadNoVNC(() => {
            console.log("RFB Loaded:", typeof window.RFB !== "undefined" ? "Available" : "Not Loaded");
        });
    </script>
</head>
<body>
     <!-- INFO PANELS -->
    <div class="vm-infoboxes-wrapper hidden" id="mainInterface_right">
     <!-- VM INFO PANEL -->
        <div class="vm-infobox-container">
            <div class="vm-infobox-header">
                <input type="checkbox" id="vm-infobox-toggle">
                <label for="vm-infobox-toggle" class="vm-infobox-head" id="vm-infobox-header-text">VM Machine Info</label>
                <div class="vm-infobox-content">
                    <div class="vm-infobox-content-text">
                        Status
                        <div class="vm-infobox-data-text" id="vm-infobox-vmstatus">
                        <!-- runnig -->
                        </div>
                        <div class="vm-infobox-content-data-small" id="vm-infobox-OSname">
                            OS: 
                        </div>
                        <div class="vm-infobox-content-data-text">
                            <img id="vm-infobox-OS-icon" class="vm-infobox-content-data-icon" src="{{ url_for('static', filename='images/os_default.png') }}">
                        </div>
                    </div>
                    <div class="vm-infobox-content-text">
                        IP Address
                        <div id="vm-infobox-Ipaddress"class="vm-infobox-data-text">
                        </div>
                        <div id="vm-infobox-vmhostname" class="vm-infobox-content-data-small">
                            Hostname: 
                        </div>
                        <div class="vm-infobox-content-text">
                            <div class="cpu-graph-container">
                                <canvas id="cpuUsageChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="vm-infobox-content-text">
                        CPU Usage
                        <div class="vm-infobox-data-text"  id="vm-infobox-CPU-usage">
                            <!--16% of 4 CPUs-->
                        </div>
                        <div class="vm-infobox-content-data-small" >
                            <div  class="vm-infobox-content-statusbar">
                                <div  class="vm-infobox-content-statusbar-CPU">
                                </div>
                            </div>
                            <div id="vm-infobox-uptime">Uptime: </div>
                        </div>
                    </div >
                    <div class="vm-infobox-content-text">
                        Memory Usage
                        <div class="vm-infobox-data-text"  id="vm-infobox-MEM-usage">
                            <!--67% (2.7GB/4GB)-->
                        </div>
                        <div class="vm-infobox-content-data-small">
                            <div  class="vm-infobox-content-statusbar">
                                <div  class="vm-infobox-content-statusbar-MEM">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    <!-- VM USER INFO PANEL -->
    <div class="vm-infobox-user-container">
        <div class="vm-infobox-header">
            <input type="checkbox" id="vm-infobox-toggle-user" class="vm-toggle-checkbox">
            <label for="vm-infobox-toggle-user" class="vm-infobox-head" id="vm-infobox-user-header-text">VM User Info</label>
            <div class="vm-infobox-content">
                <div class="vm-infobox-content-text">
                    <!-- User info content goes here -->
                </div>
            </div>
        </div>
    </div>
    </div>
    <!-- Login Screen -->
    <div class="login-container" id="loginContainer">
        <h2>Secure Login</h2>
        <form id="loginForm" onsubmit="event.preventDefault(); attemptLogin();">
            <input type="text" id="username" placeholder="Username" required autocomplete="username">
            <input type="password" id="password" placeholder="Password" required autocomplete="current-password" autocorrect="off" spellcheck="false">
            <button type="submit">Login</button>
        </form>
        <div class="error" id="loginError"></div>
        <div class="security-info">
            <p>Failed attempts: <span id="attemptCount">0</span>/5</p>
        </div>
    </div>
    <!-- Main Proxmox Interface (hidden until login) -->
    <div class="container hidden" id="mainInterface">
        <div class="user-menu-wrapper">
            <img  class="logo-placeholder" src="{{ url_for('static', filename='images/main_icon_placeholder.png') }}" alt="web gui logo"> <div class="logo-placeholder-text">PROXMOX WEBGUI</div>
            <img  id="profile-pic" class="logout-btnimg" src="{{ url_for('static', filename='images/user.png') }}" alt="User Icon" onclick="toggleUserMenu()">
            <span class="logout-btntxt" id="username-display">username</span>
            <div class="user-dropdown" id="usermenuwrapper">
                    <hr class="logout-div">
                    <button class="logout-btn" onclick="logout()">
                    <img src="{{ url_for('static', filename='images/logout.png') }}" alt="Logout Icon">  
                     Log out
                    </button>
            </div>
        </div>
      <!-- VM selector/content here -->
      <div class="vm-selector">
        <h2>Select VM Console</h2>
        <select id="vmSelect">
            <option value="">-- Choose a VM --</option>    
        </select>
        <button id="vmBtnSelect" onclick="connectToVM()">Connect</button>
        <div class="status" id="status"></div>
    </div>
    <div id="vnc-container">
                <button id="sidebar-toggle" onclick="toggleSidebar()">></button>
        <!-- Sidebar for NoVNC Controls -->
        <div id="vnc-sidebar">
            <h3>VNC Controls</h3>
            <button class="sidebar-btn" onclick="toggleFullscreen()">
                <img class="sidebar-icons" src="{{ url_for('static', filename='images/maximize_key_white.png') }}" alt="Full Screen Icon">
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Fullscreen</button>
            <button class="sidebar-btn" onclick="toggleScaling()">
                <img class="sidebar-icons" src="{{ url_for('static', filename='images/scale_action_white.png') }}" alt="Scaling Icon">
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Toggle Scaling</button>
            <button class="sidebar-btn" onclick="sendCtrlAltDel()">
                <img class="sidebar-icons" src="{{ url_for('static', filename='images/ctl_alt_del_action_white.png') }}" alt="CTL ALT DEL Icon">
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Send Ctrl+Alt+Del</button>
            <button class="sidebar-btn" onclick="copyToClipboard()">
            <img class="sidebar-icons" src="{{ url_for('static', filename='images/clipboard_action_white.png') }}" alt="Clipboard Icon">
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Copy Clipboard</button>
            <div class="key-grid" >
                <button class="sidebar-key" onclick="sendKey('Escape')">     <img class="sidebarKey-icons" src="{{ url_for('static', filename='images/escape_key_white.png') }}"   alt="ESC key Icon" ></button> 
                <button class="sidebar-key" onclick="sendKey('MetaLeft')">   <img class="sidebarKey-icons" src="{{ url_for('static', filename='images/Win_key_white.png') }}"      alt="WIN key Icon" ></button>
                <button class="sidebar-key" onclick="sendKey('ControlLeft')"><img class="sidebarKey-icons" src="{{ url_for('static', filename='images/ctrl_key_white.png') }}"     alt="CTRL key Icon"></button>
                <button class="sidebar-key" onclick="sendKey('AltLeft')">    <img class="sidebarKey-icons" src="{{ url_for('static', filename='images/Alt_key_white.png') }}"      alt="ALT key Icon" ></button>
                <button class="sidebar-key" onclick="sendKey('Tab')">        <img class="sidebarKey-icons" src="{{ url_for('static', filename='images/Tab_key_white.png') }}"      alt="TAB key Icon" ></button>
                <button class="sidebar-key">                                 <img class="sidebarKey-icons" src="{{ url_for('static', filename='images/who_icon_key_white.png') }}" alt="?">            </button>
            </div>
        </div>
        <!-- Toggle Button -->
    </div>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
    /*             _________                      __         .__  .__  .__                    ___          ___     _______________   ________   .________
                  \____    /____    _____ _____ _/  |______  |  | |  | |__| ____ _____       /  /   ____   \  \    \_____  \   _  \  \_____  \  |   ____/
                    /     /\__  \  /     \\__  \\   __\__  \ |  | |  | |  |/ ___\\__  \     /  /  _/ ___\   \  \    /  ____/  /_\  \  /  ____/  |____  \ 
                   /     /_ / __ \|  Y Y  \/ __ \|  |  / __ \|  |_|  |_|  \  \___ / __ \_  (  (   \  \___    )  )  /       \  \_/   \/       \  /       \
                  /_______ (____  /__|_|  (____  /__| (____  /____/____/__|\___  >____  /   \  \   \___  >  /  /   \_______ \_____  /\_______ \/______  /
                          \/    \/      \/     \/          \/                  \/     \/     \__\      \/  /__/            \/     \/         \/       \/ 
    */
    </script>
</body>
</html>